<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>もやぽん Demo – かわいい版</title>
  <!-- ふんわり可愛いトーン。オンライン時は丸みのあるフォント、オフラインでもOK -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --sky:#cfeaff; /* ふんわり空色 */
      --cloud:#ffffffcc; /* うすい雲ガラス */
      --ink:#374151; /* 文字 */
      --sub:#6b7280;
      --pink:#f9a8d4; /* アクセント */
      --mint:#99f6e4;
      --lemon:#fde68a;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --stroke:#eaeef5;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--ink);
      font-family: Nunito, 'Noto Sans JP', system-ui, -apple-system, Segoe UI, Roboto, 'Hiragino Kaku Gothic ProN', 'Yu Gothic', Meiryo, sans-serif;
      background:
        radial-gradient(60% 40% at 10% 0%, #fff 0, transparent 60%),
        radial-gradient(50% 50% at 90% 10%, #fff 0, transparent 60%),
        linear-gradient(#e6f4ff, var(--sky));
    }
    .container{ max-width:1080px; margin:0 auto; padding:20px; }

    /* ヘッダー（ヒーロー） */
    .hero{ display:flex; gap:18px; align-items:center; justify-content:space-between; background:var(--cloud); backdrop-filter: blur(6px);
      border:2px solid var(--stroke); border-radius:24px; padding:16px 18px; box-shadow:var(--shadow); }
    .brand{ display:flex; align-items:center; gap:14px; }
    .mascot{ width:72px; height:72px; border-radius:20px; object-fit:cover; border:3px solid #fff; box-shadow:var(--shadow); background:#fff; }
    .title{ font-size:26px; font-weight:800; letter-spacing:.02em; }
    .sub{ color:var(--sub); font-size:13px; }

    .tabs{ display:flex; gap:10px }
    .btn{ appearance:none; border:none; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:700; box-shadow:var(--shadow); transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active{ transform: translateY(1px) }
    .btn-primary{ background: linear-gradient(180deg, #ffe0ef, #ffd4ea); border:2px solid #ffd6eb; }
    .btn-ghost{ background:#fff; border:2px solid var(--stroke) }

    /* カード */
    .grid{ display:grid; gap:16px }
    .grid-2{ grid-template-columns:1.3fr .9fr }
    .card{ background:var(--cloud); border:2px solid var(--stroke); border-radius:24px; padding:16px; box-shadow:var(--shadow) }

    input, select, textarea{ width:100%; border:2px solid var(--stroke); border-radius:16px; padding:10px; background:#fff; font:inherit }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:12px; border:2px solid var(--stroke); background:#fff }
    .pill.anon{ background:linear-gradient(90deg,#fff,#fff5); }

    .post{ border:2px dashed #f0f2f8; background:#fff; border-radius:18px; padding:12px }
    .muted{ color:var(--sub) }
    .heading{ font-weight:800; font-size:18px; margin-bottom:6px }

    .chip{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:2px solid var(--stroke); background:#fff }
    .chip.school{ background:#e0f2ff } .chip.friend{ background:#efe5ff }
    .chip.home{ background:#e7fff6 } .chip.love{ background:#ffe9f4 } .chip.other{ background:#fff7db }

    .heart{ color:#ff7aa2 }
  </style>
</head>
<body>
  <div class="container">
    <!-- ヒーロー：ここで送ってもらった画像を使用します。ファイル名は sheep.png を想定 -->
    <div class="hero">
      <div class="brand">
        <img src="sheep.png" alt="もやぽんマスコット" class="mascot" />
        <div>
          <div class="title">もやぽん Demo</div>
          <div class="sub">高校生のための“やさしい相談部屋” <span class="heart">♥</span> 1ファイル/オフラインOK</div>
        </div>
      </div>
      <div class="tabs">
        <button id="tabPosts" class="btn btn-primary">投稿</button>
        <button id="tabInsights" class="btn btn-ghost">インサイト</button>
      </div>
    </div>

    <!-- 認証カード -->
    <div id="auth" class="card" style="margin-top:16px; max-width:760px;">
      <div class="heading">はじめる</div>
      <div class="muted" style="margin-bottom:8px;">同じ<strong>学校コード</strong>の人だけで見える、クローズドなお部屋です。</div>
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:14px;">
        <div>
          <div class="muted" style="font-size:12px;">ロール</div>
          <div style="display:flex; gap:8px; margin-top:6px;">
            <label class="pill"><input type="radio" name="role" value="student" checked> 相談者</label>
            <label class="pill"><input type="radio" name="role" value="advisor"> アドバイザー</label>
          </div>
        </div>
        <div>
          <div class="muted" style="font-size:12px;">学校コード</div>
          <input id="school" placeholder="例）SHOWA-1A" />
        </div>
        <div>
          <div class="muted" style="font-size:12px;">ニックネーム</div>
          <input id="nickname" placeholder="匿名の表示名" />
        </div>
        <div id="advBlock" style="display:none;">
          <div class="muted" style="font-size:12px;">アドバイザー確認コード（デモ）</div>
          <input id="advcode" placeholder="advisor123" />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="loginBtn" class="btn btn-primary">入室する</button>
        <span class="muted" style="align-self:center;">* データはこのブラウザだけに保存されます</span>
      </div>
    </div>

    <!-- アプリ本体 -->
    <div id="app" style="margin-top:16px; display:none;">
      <div class="grid grid-2">
        <div class="grid">
          <div class="card">
            <div class="heading">新規投稿 <span class="pill anon">匿名</span></div>
            <div id="composerForAdvisor" class="muted" style="display:none;">アドバイザーは投稿できません（返信のみ）。</div>
            <div id="composer">
              <div style="display:flex; gap:8px; align-items:center;">
                <select id="mood">
                  <option>学校</option>
                  <option>友人</option>
                  <option>家庭</option>
                  <option>恋愛</option>
                  <option>その他</option>
                </select>
                <span class="pill">カテゴリ</span>
              </div>
              <textarea id="text" rows="5" style="margin-top:10px;" placeholder="やさしい言葉で、もやもやをそっと吐き出してね"></textarea>
              <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                <button id="send" class="btn btn-primary">投稿する</button>
                <span id="warn" class="muted"></span>
              </div>
            </div>
          </div>

          <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
              <div class="heading">みんなの相談</div>
              <div style="display:flex; gap:8px;">
                <select id="filter">
                  <option value="all">すべて</option>
                  <option>学校</option>
                  <option>友人</option>
                  <option>家庭</option>
                  <option>恋愛</option>
                  <option>その他</option>
                </select>
                <button class="btn btn-ghost" id="resetBtn">（管理）初期化</button>
              </div>
            </div>
            <div id="list" class="grid" style="margin-top:10px;"></div>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="heading">空間の情報</div>
            <div id="headerInfo" class="muted" style="margin-bottom:8px;"></div>
            <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px;">
              <div class="post"><div class="muted">学校</div><div id="c_school" style="font-weight:800; font-size:20px;"></div></div>
              <div class="post"><div class="muted">友人</div><div id="c_friend" style="font-weight:800; font-size:20px;"></div></div>
              <div class="post"><div class="muted">家庭</div><div id="c_home" style="font-weight:800; font-size:20px;"></div></div>
              <div class="post"><div class="muted">恋愛</div><div id="c_love" style="font-weight:800; font-size:20px;"></div></div>
              <div class="post" style="grid-column:1/-1;"><div class="muted">その他</div><div id="c_other" style="font-weight:800; font-size:20px;"></div></div>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn btn-ghost" id="exportBtn">エクスポート</button>
              <label class="btn btn-ghost" style="cursor:pointer;">
                インポート<input id="importFile" type="file" accept="application/json" style="display:none;">
              </label>
            </div>
          </div>

          <div class="card">
            <div class="heading">メンバー</div>
            <div id="members" class="grid" style="grid-template-columns:1fr; gap:8px;"></div>
          </div>
        </div>
      </div>

      <div id="viewInsights" class="card" style="margin-top:16px; display:none;">
        <div class="heading">インサイト</div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px;">
          <div class="post"><div class="muted">投稿総数</div><div id="i_total" style="font-size:28px; font-weight:800;"></div></div>
          <div class="post"><div class="muted">返信率</div><div id="i_rate" style="font-size:28px; font-weight:800;"></div></div>
        </div>
        <div class="muted" style="margin-top:8px;">※ 緊急の安全に関わる内容は、アプリ外で学校・保護者・専門機関へ。</div>
        <div style="height:8px"></div>
        <div class="heading">最近の投稿（5件）</div>
        <div id="i_latest" class="grid" style="grid-template-columns:1fr 1fr; gap:10px;"></div>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = 'moyapon_cute_v1';
    const BANNED = ['殺す','自殺','死ね','住所','電話番号','LINE ID'];
    let session = null; // { role, nickname, school }

    const $ = (id)=>document.getElementById(id);
    const uid = ()=>Math.random().toString(36).slice(2,10);
    const now = ()=>new Date().toISOString();
    const loadDB=()=>{ try{ const raw=localStorage.getItem(LS_KEY); return raw?JSON.parse(raw):{schools:{}};}catch(e){return {schools:{}}} }
    const saveDB=(db)=> localStorage.setItem(LS_KEY, JSON.stringify(db));
    const getSpace=(db, school)=> db.schools[school] || { posts:[], profiles:{} };
    const setSpace=(db, school, space)=>{ db.schools[school]=space; saveDB(db); };

    // ロール切替でアドバイザーコード表示
    document.getElementsByName('role').forEach(r=>{
      r.addEventListener('change',()=>{
        const advisor = r.value==='advisor' && r.checked;
        $('advBlock').style.display = advisor ? 'block':'none';
      })
    });

    $('loginBtn').addEventListener('click',()=>{
      const role = [...document.getElementsByName('role')].find(r=>r.checked).value;
      const school = $('school').value.trim();
      const nickname = $('nickname').value.trim();
      if(!school || !nickname){ alert('学校コードとニックネームを入力してください'); return; }
      if(role==='advisor' && $('advcode').value !== 'advisor123'){ alert('アドバイザー確認コードが違います（demo: advisor123）'); return; }
      session = { role, nickname, school };
      $('auth').style.display='none';
      $('app').style.display='block';
      initApp();
    });

    function initApp(){
      renderMembers();
      renderList();
      updateCounts();
      updateInsights();
      $('headerInfo').innerHTML = `学校コード: <span class="pill">${session.school}</span> ／ ロール: <span class="pill">${session.role==='advisor'?'アドバイザー':'相談者'}</span> ／ ${session.nickname}`;
      $('composerForAdvisor').style.display = session.role==='advisor' ? 'block':'none';
      $('composer').style.display = session.role==='advisor' ? 'none':'block';
    }

    // タブ
    $('tabPosts').addEventListener('click',()=>{
      $('tabPosts').classList.add('btn-primary');
      $('tabInsights').classList.remove('btn-primary');
      $('viewInsights').style.display='none';
    });
    $('tabInsights').addEventListener('click',()=>{
      $('tabInsights').classList.add('btn-primary');
      $('tabPosts').classList.remove('btn-primary');
      $('viewInsights').style.display='block';
      updateInsights();
    });

    // 投稿
    $('send').addEventListener('click',()=>{
      const text = $('text').value.trim();
      const mood = $('mood').value;
      const w = warnMsg(text);
      if(w){ $('warn').textContent = w; return; } else { $('warn').textContent=''; }
      const db = loadDB();
      const space = getSpace(db, session.school);
      space.posts.push({ id: uid(), text, mood, createdAt: now(), author:'anon-'+uid(), replies:[] });
      space.profiles[session.nickname] = { role: session.role, joinedAt: now() };
      setSpace(db, session.school, space);
      $('text').value='';
      renderList(); updateCounts(); updateInsights();
    });

    function warnMsg(text){
      if(!text) return '内容を入力してください';
      if(text.length>2000) return '長文すぎます（2000字以内）';
      const hit = BANNED.find(w=>text.includes(w));
      if(hit) return '不適切な語句が含まれています：「'+hit+'」';
      return '';
    }

    // フィルター & 初期化
    $('filter').addEventListener('change', renderList);
    $('resetBtn').addEventListener('click',()=>{
      if(!confirm('この学校コードのデータを全て削除します。よろしいですか？')) return;
      const db = loadDB();
      delete db.schools[session.school];
      saveDB(db); renderMembers(); renderList(); updateCounts(); updateInsights();
    });

    // メンバー
    function renderMembers(){
      const box = $('members'); box.innerHTML='';
      const db = loadDB();
      const space = getSpace(db, session.school);
      space.profiles[session.nickname] = space.profiles[session.nickname] || { role: session.role, joinedAt: now() };
      setSpace(db, session.school, space);
      const entries = Object.entries(space.profiles).map(([name,v])=>({name, ...v})).sort((a,b)=>a.name.localeCompare(b.name));
      if(entries.length===0){ box.innerHTML='<div class="muted">メンバーなし</div>'; return; }
      entries.forEach(m=>{
        const row = document.createElement('div'); row.className='post';
        row.innerHTML = `<span class="chip ${m.role==='advisor'?'friend':'school'}">${m.role==='advisor'?'アドバイザー':'相談者'}</span> <strong>${m.name}</strong><div class="muted" style="margin-top:4px;">${new Date(m.joinedAt).toLocaleString()}</div>`;
        box.appendChild(row);
      });
    }

    // 投稿一覧 & 返信
    function renderList(){
      const list = $('list'); list.innerHTML='';
      const db = loadDB(); const space = getSpace(db, session.school);
      const f = $('filter').value;
      const posts = [...space.posts].sort((a,b)=>b.createdAt.localeCompare(a.createdAt)).filter(p=> f==='all' ? true : p.mood===f);
      if(posts.length===0){ list.innerHTML = '<div class="muted">まだ投稿がありません</div>'; return; }
      posts.forEach(p=>{
        const card = document.createElement('div'); card.className='post';
        const head = document.createElement('div'); head.innerHTML = `<span class="chip ${chipCls(p.mood)}">${p.mood}</span> <span class="muted">${new Date(p.createdAt).toLocaleString()}</span>`;
        const body = document.createElement('div'); body.style.marginTop='6px'; body.textContent=p.text;
        const footer = document.createElement('div'); footer.className='muted'; footer.textContent='投稿者: '+p.author;
        card.append(head, body, footer);

        if(p.replies?.length){
          p.replies.forEach(r=>{
            const rep = document.createElement('div'); rep.className='post'; rep.style.background='#fff7fb'; rep.style.marginTop='8px';
            rep.innerHTML = `<span class="chip friend">アドバイザー</span> <strong>${r.advisor}</strong> <span class="muted">${new Date(r.createdAt).toLocaleString()}</span><div style="margin-top:6px;">${r.text}</div>`;
            card.appendChild(rep);
          });
        }

        if(session.role==='advisor'){
          const area = document.createElement('textarea'); area.rows=3; area.placeholder='相手を尊重した言葉で返信しましょう'; area.style.marginTop='8px';
          const btn = document.createElement('button'); btn.textContent='返信する'; btn.className='btn btn-ghost'; btn.style.marginTop='6px';
          btn.addEventListener('click',()=>{
            const t = area.value.trim(); const w = warnMsg(t); if(w){ alert(w); return; }
            p.replies = p.replies || []; p.replies.push({ id: uid(), text: t, advisor: session.nickname, createdAt: now() });
            area.value=''; setSpace(db, session.school, space); renderList(); updateInsights();
          });
          card.append(area, btn);
        }
        list.appendChild(card);
      });
    }

    function chipCls(m){
      return m==='学校'?'school': m==='友人'?'friend': m==='家庭'?'home': m==='恋愛'?'love':'other';
    }

    // 集計
    function updateCounts(){
      const db = loadDB(); const space = getSpace(db, session.school);
      const c = { '学校':0, '友人':0, '家庭':0, '恋愛':0, 'その他':0 };
      space.posts.forEach(p=> c[p.mood]=(c[p.mood]||0)+1 );
      $('c_school').textContent=c['学校']; $('c_friend').textContent=c['友人']; $('c_home').textContent=c['家庭']; $('c_love').textContent=c['恋愛']; $('c_other').textContent=c['その他'];
    }

    function updateInsights(){
      const db = loadDB(); const space = getSpace(db, session.school);
      const total = space.posts.length; const replied = space.posts.filter(p=> (p.replies||[]).length>0).length;
      const rate = total===0?0:Math.round((replied/total)*100);
      $('i_total').textContent = total; $('i_rate').textContent = rate+'%';
      const latest = [...space.posts].sort((a,b)=>b.createdAt.localeCompare(a.createdAt)).slice(0,5);
      const box = $('i_latest'); box.innerHTML='';
      latest.forEach(p=>{
        const item = document.createElement('div'); item.className='post';
        item.innerHTML = `<span class="chip ${chipCls(p.mood)}">${p.mood}</span> <span class="muted">${new Date(p.createdAt).toLocaleString()}</span><div style="margin-top:6px;" class="muted">${p.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>`;
        box.appendChild(item);
      });
    }

    // エクスポート/インポート
    $('exportBtn').addEventListener('click',()=>{
      const db = loadDB(); const space = getSpace(db, session.school);
      const blob = new Blob([JSON.stringify(space,null,2)], { type:'application/json' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href=url; a.download='moyapon_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
    });
    $('importFile').addEventListener('change', e=>{
      const file = e.target.files?.[0]; if(!file) return; const reader = new FileReader();
      reader.onload = ()=>{ try{ const obj = JSON.parse(reader.result); if(!obj.posts||!obj.profiles) throw new Error('invalid'); const db=loadDB(); setSpace(db, session.school, obj); renderMembers(); renderList(); updateCounts(); updateInsights(); alert('インポート完了'); } catch{ alert('読み込みに失敗しました'); } };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
